<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>
The Reactive Machine | States
</title>
    
<link rel="stylesheet" href="/ReactiveMachine/css/style.af54df87ff3bd3c2c433dbfd4c3a7ecb417849c15384eba8e9fb6f7b5a9de6e2.css">
<link rel="stylesheet" href="/ReactiveMachine/css/syntax.de5a118cd688caecccb0905dc27fdf35ea42b86621e7f077f96723087430564e.css">
<link rel="shortcut icon" href="/ReactiveMachine/img/logo-icon.png">

  </head>
  <body class="page has-navbar-fixed-top">
    <main class="main">
      

<nav class="navbar is-fixed-top">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://microsoft.github.io/ReactiveMachine">
        <img src="/ReactiveMachine/img/logo-icon.png">
      </a>

      <a class="navbar-item has-text-primary has-text-weight-bold" href="https://microsoft.github.io/ReactiveMachine">
        Reactive Machine
      </a>

      <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbar-menu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navbar-menu" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/ReactiveMachine/docs">
          Docs
        </a>
        <a class="navbar-item" href="https://github.com/Microsoft/ReactiveMachine">
          GitHub
        </a>
      </div>
    </div>
  </div>
</nav>


      
<section class="hero is-primary">
  <div class="hero-body">
    <div class="container">
      <p class="title is-size-1 is-size-2-mobile has-text-weight-light is-spaced">
        States
      </p>
      <p class="subtitle is-size-3 is-size-4-mobile has-text-weight-light">
        store information durably
      </p>
    </div>
  </div>
</section>
  

<nav class="tabs">
  <div class="container">

    <ul> 
          <li>
            <a href="/ReactiveMachine/docs/">
              Overview
            </a>
          </li> 
          <li class="is-active">
            <a href="/ReactiveMachine/docs/model/">
              Programming Model
            </a>
          </li> 
          <li>
            <a href="/ReactiveMachine/docs/hosts/">
              Hosts
            </a>
          </li> 
          <li>
            <a href="/ReactiveMachine/docs/examples/">
              Examples
            </a>
          </li> 
          <li>
            <a href="/ReactiveMachine/docs/motivation/">
              Motivation
            </a>
          </li>
    </ul>
  </div>
</nav>



    
       
      
          <nav class="tabs" style="margin-top: -25px;">
            <div class="container">
              <ul>
        
                <li class="">
                    <a href="/ReactiveMachine/docs/model-orchestrations/">Orchestrations</a>
                </li>
        
                <li class="">
                    <a href="/ReactiveMachine/docs/model-activities/">Activities</a>
                </li>
        
                <li class="">
                    <a href="/ReactiveMachine/docs/model-affinities/">Affinities</a>
                </li>
        
                <li class="is-active">
                    <a href="/ReactiveMachine/docs/model-states/">States</a>
                </li>
        
                <li class="">
                    <a href="/ReactiveMachine/docs/model-events/">Events</a>
                </li>
        
              </ul>
            </div>
          </nav>
      
    

    
       
      
    

    
       
      
    


<div class="container docs-container">
  <div class="content">
    

<p>States are used to store information durably and scalably. To use state in a reactive machine application, you</p>

<ul>
<li>must define how the state should be partitioned, by declaring an <strong>affinity</strong>.</li>
<li>must define the <strong>state</strong> to be stored.</li>
</ul>

<p>Then, there are a variety of options about how the state should be managed and accessed. You</p>

<ul>
<li>may define <strong>read</strong> operations that can access the state and return a value</li>
<li>may define <strong>update</strong> operations that can read and update the state and return a value</li>
<li>may define an <strong>initialize</strong> orchestration that is called when the state is initialized</li>
<li>may define event <strong>subscriptions</strong> that can update the state in response to an event</li>
</ul>

<h3 id="example-1-account-state">Example 1: Account State</h3>

<p>Suppose we are implementing a service whose customers have some sort of account, containing some form of currency. Conceptually, we need something like <code>Dictionary&lt;Guid,AccountState&gt;</code>; however, a simple dictionary is not good enough: the runtime should durably persist the data, and distribute it over all the machines in the cluster.</p>

<p>First, we define a <strong>partitioned affinity</strong>, i.e. the &ldquo;type of the key&rdquo;, by defining an interface <code>IAccountAffinity</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IAccountAffinity</span> <span class="p">:</span> <span class="n">IPartitionedAffinity</span><span class="p">&lt;</span><span class="n">IAccountAffinity</span><span class="p">,</span><span class="n">Guid</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="n">Guid</span> <span class="n">AccountId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Second, we define the <strong>state</strong> of the account, i.e. the &ldquo;type of the value&rdquo;. We do this by defining a class</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountState</span> <span class="p">:</span> <span class="n">IPartitionedState</span><span class="p">&lt;</span><span class="n">IAccountAffinity</span><span class="p">,</span><span class="n">Guid</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Owner</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Balance</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>Note that it is not necessary to include the <code>AccountId</code> in the state.</p>

<p>Next, we define operations to access the account state. Read and update operations are defined as serializable classes with an <code>Execute</code> method. The execute method provides a <code>context</code> object that contains the current state as a property <code>context.State</code>.</p>

<p>For example, we can define a <strong>read operation</strong> that returns an integer (the balance) by defining a new serializable class that implements <code>IRead</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ReadBalance</span> <span class="p">:</span> <span class="n">IRead</span><span class="p">&lt;</span><span class="n">AccountState</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;,</span> <span class="n">IAccountAffinity</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">AccountId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">Execute</span><span class="p">(</span><span class="n">IReadContext</span><span class="p">&lt;</span><span class="n">AccountState</span><span class="p">&gt;</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">$&#34;now reading account with id {AccountId}&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">State</span><span class="p">.</span><span class="n">Balance</span><span class="p">;</span> 
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>This class implements <code>IAccountAffinity</code>, so that the runtime can determine which account is being targeted by getting the <code>AccountId</code> property. Inside the <code>Execute</code> method, we can use the <code>context</code> object to access the state and read the balance. A read operation <em>must not</em> modify the state &ndash; doing so can corrupt the runtime.</p>

<p>To <em>execute this read</em> operation from within an orchestration, we construct it and pass it as an argument to <code>context.PerformRead</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">int</span> <span class="n">balance</span> <span class="p">=</span> <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">PerformRead</span><span class="p">(</span><span class="k">new</span> <span class="n">ReadBalance</span><span class="p">()</span> <span class="p">{</span> <span class="n">AccountId</span> <span class="p">=</span> <span class="n">accountId</span> <span class="p">});</span></code></pre></div>
<p>To define an <strong>update operation</strong>, we do something similar, but to make this example more interesting, we add another parameter (the amount to be withdrawn), and then we check to see if there is sufficient balance before withdrawing the amount. We return a boolean indicating whether we did indeed withdraw:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">TryWithdraw</span> <span class="p">:</span> <span class="n">IUpdate</span><span class="p">&lt;</span><span class="n">AccountState</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;,</span> <span class="n">IAccountAffinity</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">AccountId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Amount</span><span class="p">;</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="n">Execute</span><span class="p">(</span><span class="n">IUpdateContext</span><span class="p">&lt;</span><span class="n">AccountState</span><span class="p">&gt;</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">State</span><span class="p">.</span><span class="n">Balance</span> <span class="p">&lt;</span> <span class="n">Amount</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">context</span><span class="p">.</span><span class="n">State</span><span class="p">.</span><span class="n">Balance</span> <span class="p">-=</span> <span class="n">Amount</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Again, <em>to execute this update operation</em> from within an orchestration, we construct it and pass it as an argument to <code>context.PerformUpdate</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">bool</span> <span class="n">withdrawSuccessful</span> <span class="p">=</span> <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">PerformUpdate</span><span class="p">(</span><span class="k">new</span> <span class="n">TryWithdraw</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">AccountId</span> <span class="p">=</span> <span class="n">accountId</span><span class="p">,</span>
    <span class="n">Amount</span> <span class="p">=</span> <span class="m">20</span>
<span class="p">});</span></code></pre></div>
<p>Note that calling multiple withdrawal operations concurrently never produces unsafe interleavings, because all operations on a state are always serialized.</p>

<h2 id="initialization">Initialization</h2>

<p>A class defining a state must be serializable, and have a parameterless default constructor. This constructor is used to create the initial state.</p>

<p>Read operations that access a non-existent state always throw a <code>KeyNotFound</code> exception. The same is true for update operations, by default. However, this behavior can be changed by specifying the <code>[CreateIfNotExist]</code> attribute on the execute method.</p>

<p>For example, performing the following update operation ensures a state exists:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">EnsureAccountExists</span> <span class="p">:</span> <span class="n">IUpdate</span><span class="p">&lt;</span><span class="n">AccountState</span><span class="p">,</span> <span class="n">UnitType</span><span class="p">&gt;,</span> <span class="n">IAccountAffinity</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">AccountId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span><span class="na">
</span><span class="na"> 
</span><span class="na">    [CreateIfNotExist]</span>
    <span class="k">public</span> <span class="n">UnitType</span> <span class="n">Execute</span><span class="p">(</span><span class="n">IUpdateContext</span><span class="p">&lt;</span><span class="n">AccountState</span><span class="p">&gt;</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">UnitType</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>The state object is created using the default constructor. This constructor must be deterministic! For example, it must not use timestamps, random Guids, sequence numbers obtained from static counters, etc.
However, it is often desirable to do more initialization than what can be done in a default constructor. Thus, we support a special declaration for intializer orchestrations.</p>

<p>The interfaces <code>IInitialize</code> (for singleton states) and <code>IInitialize&lt;TKey&gt;</code> (for partitioned states) can be used for this purpose. If a state declares that interface, then the <code>OnInitialize</code> method is guaranteed to be called exactly once, before any other operations are applied to this state.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountState</span> <span class="p">:</span>
    <span class="n">IPartitionedState</span><span class="p">&lt;</span><span class="n">IAccountAffinity</span><span class="p">,</span> <span class="n">Guid</span><span class="p">&gt;,</span>
    <span class="n">IInitialize</span><span class="p">&lt;</span><span class="n">Guid</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Balance</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="n">OnInitialize</span><span class="p">(</span><span class="n">IInitializationContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Guid</span> <span class="n">key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">$&#34;initializing account {key}&#34;</span><span class="p">);</span>
        <span class="n">Balance</span> <span class="p">=</span> <span class="m">10</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">GlobalCounterState</span> <span class="p">:</span>
    <span class="n">ISingletonState</span><span class="p">&lt;</span><span class="n">IGlobalCounterAffinity</span><span class="p">&gt;,</span>
    <span class="n">ISubscribe</span><span class="p">&lt;</span><span class="n">SomeEvent</span><span class="p">,</span> <span class="n">IGlobalCounterAffinity</span><span class="p">&gt;,</span>
    <span class="n">IInitialize</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Count</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="n">On</span><span class="p">(</span><span class="n">ISubscriptionContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">SomeEvent</span> <span class="n">evt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Count</span><span class="p">++;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="n">OnInitialize</span><span class="p">(</span><span class="n">IInitializationContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">LogInformation</span><span class="p">(</span><span class="s">$&#34;initializing GlobalCounterState&#34;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
  </div>
</div>


    </main>

    
<footer class="footer has-background-dark">
  <div class="container has-text-centered">
    <p class="is-size-5 is-size-6-mobile has-text-white-bis">
      &copy; 2020 Microsoft Corporation
    </p>
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="/ReactiveMachine/js/app.min.e119cad0205945173c83cdb2ffec7a581007a612e088c70bd62c7245ad7e58cb.js" integrity=""></script>

  </body>
</html>
